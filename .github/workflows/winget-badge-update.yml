name: Winget version badge update

on:
   workflow_dispatch:
   workflow_run:
     workflows: [Publish to WinGet]
     types:
       - completed

jobs:
  update-badge:
    name: Update latest version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Winget Version Badge
        uses: gnpaone/winget-version-badge@v1.0.3
        with:
          id: "rcmaehl.MSEdgeRedirect"
          marker_text: "WINGET_PKG"
          pkg_link: "https://github.com/microsoft/winget-pkgs/tree/master/manifests/r/rcmaehl/MSEdgeRedirect"
          newline: "false"
          color: "brightgreen"
          confirm_and_push: "false"
        id: latestver

      - name: Create pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "${{ steps.latestver.outputs.commit_message }}"
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          branch: github-actions/repo-update
          delete-branch: true
          title: Update README

      - name: Enable pull request automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.MSEdgeRedirect_PAT }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Auto approve
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: juliangruber/approve-pull-request-action@v2
        with:
          github-token: ${{ secrets.MSEdgeRedirect_PAT }}
          number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Delete PRs head branch
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: dawidd6/action-delete-branch@v3
        with:
          github_token: ${{ secrets.MSEdgeRedirect_PAT }}
          numbers: ${{ steps.cpr.outputs.pull-request-number }}
          
